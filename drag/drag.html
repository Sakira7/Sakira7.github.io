<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="manifest" href="drag-manifest.json"/>
        <meta name="msapplication-TileColor" content="#222">
        <meta name="theme-color" content="#000">
        <title>Drag</title>
        <link href="drag.css" rel="stylesheet">
        
    </head>
    <body>
        <script>
            
                async function fetchWithTimeout(url, ms = 30000){
                    const ctrl = new AbortController();
                    const t = setTimeout(() => ctrl.abort(),ms);
                    try {
                        return await fetch(url, {signal: ctrl.signal, cache:"no-store"});
                    } finally {
                        clearTimeout(t);
                    }
                }
            
                async function central(){
                    const base = `https://proxy-9x3u.onrender.com/api`;
                    try{
                        await fetch(base.replace("/api", "/health"), {chache:"no-store"});
                    }catch{ 

                    }
                    const target = `https://connect.idpit.se/jpinfo.php?format=json`;
                    const url = `${base}?url=${encodeURIComponent(target)}&t=${Date.now()}`; //cache-buster

                    for (let attempt = 1; attempt <= 3; attempt++){
                        try{
                            const ms = (attempt ===1) ? 90000 : 30000;
                            const res = await fetchWithTimeout(url, ms);
                            if(!res.ok){
                                const txt = await res.text();
                                throw new Error(`Proxy ${res.status}: ${txt.slice(0,200)}`);
                            }
                            const data = await res.json();
                            const d = data[0];
                            if(!d)throw new Error(`Unexpected payload`);
                            document.getElementById("eldo").value = d.eldorado;
                            document.getElementById("sp1").value = d.rad1;
                            document.getElementById("sp2").value = d.rad2;
                            document.getElementById("sp3").value = d.rad3;
                            document.getElementById("dp").value = d.drom;
                            return;
                        }catch(e){
                            if(attempt === 3){
                                console.error("Fetch failed: ", e);
                                console.log("Failed");
                            }else{
                                await new Promise(r => setTimeout(r, 1500)); //brief backoff
                            }
                        }
                    }

                }

            window.addEventListener("load", function fill(){

                central();
                console.log("WORK PLEASE");

                let col = document.getElementsByTagName("input");
                let val = col.length;
                document.getElementById("last_updt").innerHTML = localStorage.getItem("last_updt");

                for(var i = 0; i < val; i++){
                    if(window.localStorage.length > 0){
                        col[i].value = localStorage.getItem("value"+i);   
                    }
                }
               
            });

                window.addEventListener("keydown", (e)=>{
                    if(e.target.nodeName == "INPUT"){
                        if(!e.key.match(/[0-9]/) && e.key != "Backspace" && e.key != "Tab" && e.key != "ArrowLeft" && e.key != "ArrowRight"){
                            e.preventDefault();
                        }
                    }
                });



                window.addEventListener("beforeunload", ()=>{
                    closeWindow();
                });



        </script>
        <div class="content">
            <form id="jackpot">
                <div id="left-row">
                    <p id="rubrik1">Lokala spel</p>

                    <span class="wrap"><label for="zata">Zäta</label>
                        <input type="text" id="zata" placeholder="30" maxlength="2"></span>

                    <span class="wrap"><label for="fc">Färgchansen</label>
                        <input type="text" id="fc" placeholder="55" maxlength="2"></span>


                    <label for="ss1" class="ss">Sjöstjärnan</label>
                        <span class="wrapper"><input type="text" id="ss1" placeholder="8" maxlength="2"></span>
                        <span class="wrapper"><input type="text" id="ss2" placeholder="35" maxlength="2"></span>
                        <span class="wrapper"><input type="text" id="ss3" placeholder="54" maxlength="2"></span>

                    <span class="wrap"><label for="jr">Jackpottresan</label>
                        <input type="text" id="jr" placeholder="3000" maxlength="5"></span><br>

                        <div id="extras">
                            <div id="widget-selector">
                                <select name="widgets" id="widgets">
                                    <option value="default" selected>-VÄLJ-</option>
                                    <option value="klocka">Klocka</option>
                                    <option value="info-box">Info-box</option>
                                </select>
                            </div>
                            <div id="info-box" hidden>
                                <div id="border">
                                    <select name="info-select" id="info-select">
                                        <option value="default" selected>-VÄLJ-</option>
                                        <option value="Missa inte:">Missa inte:</option>
                                        <option value="Kom ihåg:">Kom ihåg:</option>
                                        <option value="Tänk på:">Tänk på:</option>
                                        <option value="blank">Ingen text</option>
                                    </select>
                                    <div id="editable-content">
                                        <div id="info-input" contenteditable></div>
                                        <div id="opt"><button id="b">B</button><br><button id="i">i</button><br><button id="h" hidden>H</button></div>
                                    </div>
                                </div>
                            </div>
                            <div id="clock" hidden>
                                <div id="time"></div>
                            </div>
                        </div>

                        
                </div>


                <div id="right-row">
                    <p id="rubrik2">Centrala spel</p>
                    <span class="wrap"><label for="eldo">Eldorado</label>
                        <input type="text" id="eldo" placeholder="30000" maxlength="6"><br>
                        <p class="info">Spelas kl 14.00 och 19.00</p></span><br>
                        <div class="space"></div>

                    <span class="wrap"><label for="at">Atlantis</label>
                        <input type="text" id="at" value="10000" placeholder="10000" maxlength="6" disabled><br>
                        <p class="info">Spelas efter Eldorado</p></span><br>
                        <div class="space"></div>
    
                    <span class="wrap"><label for="sp" >Superpotten</label>
                    <p class="info">Spelas den <input type="date" id="date" placeholder="2025-01-01"></p></span><br>
                        <div class="space2"></div>
                        <span class="wrapper"><span class="row" id="row1">Rad 1 -</span><input type="text" id="sp1" placeholder="10000" maxlength="6"></span>
                        <span class="wrapper"><span class="row">Rad 2 -</span><input type="text" id="sp2" placeholder="20000" maxlength="6"></span>
                        <span class="wrapper"><span class="row">Rad 3 -</span><input type="text" id="sp3" placeholder="30000" maxlength="6"></span><br>
                    
                        <div class="space"></div>

                    <span class="wrap"><label for="dp">Drömpotten</label>
                        <input type="text" id="dp" placeholder="1000000" maxlength="7"><br>
                        <p class="info">Spelas på Bingons Dag, den 9 september</p></span><br>           
                </div>
            </form>
            <div id="bottom">
                <button id="show_btn" class="btn" onclick="update(central)">UPPDATERA DRAG</button>
                <div id="last_updt"></div>
            </div>
            <div id="pop-up">  
                <div id="pop-up-content">
                    <p id="pop-up-text">Fyll i alla fält</p>
                    <span id="ok" class="btn">OK</span>
                </div>
            </div>
        </div>
        <script src="drag.js"></script>
    </body>
</html>